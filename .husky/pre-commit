# Pre-commit hook that simulates GitHub Actions CI/CD pipeline
# This ensures local commits will pass CI before pushing

echo "ğŸ” Running pre-commit checks (GitHub Actions dry-run)..."
echo ""

# Track if any check fails
FAILED=0

# 1. Lint Job - ESLint
echo "ğŸ“‹ [1/5] Running ESLint (matches CI lint job)..."
if npm run lint; then
  echo "âœ… ESLint passed"
else
  echo "âŒ ESLint failed - fix errors before committing"
  FAILED=1
fi
echo ""

# 2. Lint Job - Prettier format check
echo "ğŸ¨ [2/5] Checking code formatting (matches CI lint job)..."
if npm run format -- --check; then
  echo "âœ… Prettier format check passed"
else
  echo "âŒ Prettier format check failed - run 'npm run format' to fix"
  FAILED=1
fi
echo ""

# 3. Test Job - Run tests
echo "ğŸ§ª [3/5] Running tests (matches CI test job)..."
if npm test -- --run; then
  echo "âœ… Tests passed"
else
  echo "âŒ Tests failed - fix failing tests before committing"
  FAILED=1
fi
echo ""

# 4. Build Job - Build extension
echo "ğŸ”¨ [4/5] Building extension (matches CI build job)..."
if npm run build; then
  echo "âœ… Build passed"
else
  echo "âŒ Build failed - fix build errors before committing"
  FAILED=1
fi
echo ""

# 5. Security Job - npm audit
echo "ğŸ”’ [5/5] Running security audit (matches CI security job)..."
if npm audit --audit-level=moderate; then
  echo "âœ… Security audit passed"
else
  echo "âš ï¸  Security audit found vulnerabilities (continuing - matches CI behavior)"
  # Note: CI has continue-on-error: true for this step
fi
echo ""

# Summary
echo "========================================="
if [ $FAILED -eq 0 ]; then
  echo "âœ… All pre-commit checks passed!"
  echo "   Your commit should pass GitHub Actions CI"
  echo "========================================="
  exit 0
else
  echo "âŒ Pre-commit checks failed!"
  echo "   Your commit would fail GitHub Actions CI"
  echo "   Please fix the errors above before committing"
  echo "========================================="
  exit 1
fi
